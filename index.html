<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repository Viewer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.0/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/styles/default.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 20px;
            background-color: #f9f9f9;
            display: flex;
        }
        #sidebar {
            width: 250px;
            padding-right: 20px;
            border-right: 1px solid #ddd;
            overflow-y: auto;
            max-height: 100vh;
        }
        #content {
            flex-grow: 1;
            padding-left: 20px;
            overflow: auto;
            max-height: 100vh;
        }
        a {
            text-decoration: none;
            color: #3498db;
            cursor: pointer;
        }
        a:hover {
            text-decoration: underline;
        }
        ul {
            list-style-type: none;
            padding-left: 20px;
        }
        li {
            margin-bottom: 5px;
        }
        .folder {
            font-weight: bold;
            margin-top: 10px;
            cursor: pointer;
        }
        #pdf-viewer {
            width: 100%;
            height: 800px;
        }
        #markdown-content {
            max-width: 800px;
            background-color: white;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        #file-list ul {
            display: none;
        }
        .folder.expanded > ul {
            display: block;
        }
        .folder::before {
            content: 'â–¶ ';
            display: inline-block;
            margin-right: 5px;
            transition: transform 0.2s;
        }
        .folder.expanded::before {
            transform: rotate(90deg);
        }
    </style>
</head>
<body>
    <div id="sidebar">
        <h1>Repository Viewer</h1>
        <p>Click to view PDFs and Markdown files</p>
        <ul id="file-list"></ul>
    </div>
    <div id="content">
        <div id="markdown-content"></div>
        <canvas id="pdf-viewer"></canvas>
    </div>

    <script>
        const markdownContent = document.getElementById('markdown-content');
        const pdfViewer = document.getElementById('pdf-viewer');

        // Recursive function to create file tree
        function createFileTree(files) {
            const fileList = document.getElementById('file-list');
            fileList.innerHTML = '';

            function createFileNode(file, parent) {
                if (file.type === 'directory') {
                    const folderLi = document.createElement('li');
                    const folderSpan = document.createElement('span');
                    folderSpan.textContent = file.name;
                    folderSpan.classList.add('folder');
                    folderLi.appendChild(folderSpan);

                    const subUl = document.createElement('ul');
                    folderLi.appendChild(subUl);
                    parent.appendChild(folderLi);

                    // Expand/collapse folder
                    folderSpan.addEventListener('click', () => {
                        folderSpan.classList.toggle('expanded');
                    });

                    // Process subdirectories and files
                    file.children.forEach(child => {
                        createFileNode(child, subUl);
                    });
                } else if (file.name.endsWith('.pdf') || file.name.endsWith('.md')) {
                    const li = document.createElement('li');
                    const link = document.createElement('a');
                    link.textContent = file.name;
                    link.dataset.path = file.path;
                    link.addEventListener('click', () => viewFile(file.path));
                    li.appendChild(link);
                    parent.appendChild(li);
                }
            }

            // Start creating the file tree from the root
            files.forEach(file => createFileNode(file, fileList));
        }

        // Generate file tree structure dynamically
        function generateFileTree() {
            const fileTree = [];
            
            // This will be populated dynamically
            const filesInRepo = [
                {
                    name: 'Documents',
                    type: 'directory',
                    children: []
                }
            ];

            // Recursive function to build file tree
            function buildFileTree(directory) {
                // Use the current script's location as base
                const baseUrl = window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/') + 1);

                // Try to fetch directory contents
                return fetch(baseUrl + directory)
                    .then(response => response.text())
                    .then(html => {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        const links = doc.querySelectorAll('a');

                        links.forEach(link => {
                            const href = link.getAttribute('href');
                            
                            // Ignore parent directory and current directory links
                            if (href && !href.startsWith('.') && href !== '/') {
                                const isDirectory = href.endsWith('/');
                                const name = href.replace(/\/$/, '');

                                if (isDirectory) {
                                    // It's a directory
                                    const dirEntry = {
                                        name: name,
                                        type: 'directory',
                                        path: href,
                                        children: []
                                    };
                                    filesInRepo[0].children.push(dirEntry);
                                } else if (name.endsWith('.pdf') || name.endsWith('.md')) {
                                    // It's a file
                                    filesInRepo[0].children.push({
                                        name: name,
                                        type: 'file',
                                        path: href
                                    });
                                }
                            }
                        });

                        return filesInRepo;
                    })
                    .catch(error => {
                        console.error('Error fetching directory contents:', error);
                        return filesInRepo;
                    });
            }

            // Initial call to build the file tree
            return buildFileTree('.');
        }

        // View file contents
        async function viewFile(path) {
            // Clear previous content
            markdownContent.innerHTML = '';
            pdfViewer.style.display = 'none';

            // Ensure path is a full URL
            const fullPath = window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/') + 1) + path;

            try {
                const response = await fetch(fullPath);
                
                if (path.endsWith('.md')) {
                    const markdown = await response.text();
                    
                    // Render markdown
                    marked.setOptions({
                        highlight: function(code, lang) {
                            return hljs.highlightAuto(code, [lang]).value;
                        }
                    });
                    
                    markdownContent.innerHTML = marked.parse(markdown);
                    markdownContent.style.display = 'block';
                } else if (path.endsWith('.pdf')) {
                    // Load PDF using PDF.js
                    const loadingTask = pdfjsLib.getDocument(fullPath);
                    loadingTask.promise.then(pdf => {
                        // Render first page
                        return pdf.getPage(1).then(page => {
                            const viewport = page.getViewport({scale: 1.5});
                            pdfViewer.height = viewport.height;
                            pdfViewer.width = viewport.width;
                            
                            const renderContext = {
                                canvasContext: pdfViewer.getContext('2d'),
                                viewport: viewport
                            };
                            
                            page.render(renderContext);
                            pdfViewer.style.display = 'block';
                            markdownContent.style.display = 'none';
                        });
                    });
                }
            } catch (error) {
                markdownContent.innerHTML = `Error loading file: ${error.message}`;
                markdownContent.style.display = 'block';
            }
        }

        // Initialize
        generateFileTree().then(fileTree => {
            createFileTree(fileTree);
        });
    </script>
</body>
</html>
